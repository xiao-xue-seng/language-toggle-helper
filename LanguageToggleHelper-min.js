/*
  祈請大寶恩師加持
 */
"use strict";const toggleAttributeName="data-toggle-lang",langs=[{id:"bo",label:"藏文"},{id:"zh",label:"中文"},{id:"classical",label:"古文"},{id:"modern",label:"白話"}];function ensureValue(e,t=!0){return null!=e?e:t}export class SwitchConfig{constructor(e={}){e=ensureValue(e,{}),langs.forEach((t=>{this[t.id]=ensureValue(e[t.id])}))}}class DataItem{constructor(e="",t=!0,a=!1,n="",l=function(e){}){this._lang=e,this._enabled=t,this.available=a,this._label=n,this.onEnabledChange=l}get lang(){return this._lang}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this.onEnabledChange(this))}available;get label(){return this._label}}const regexes=Object.fromEntries(langs.map((({id:e})=>[e,new RegExp(`<[^>]+?data-toggle-lang\\s*=\\s*['"]?${e}`)])));function getLangToEnabledMap(e){return Object.fromEntries(e.map((e=>[e.lang,e.enabled])))}const userSettings=function(){const e="AMEC_LanguageToggleState";return{saveToggleState(t){localStorage.setItem(e,JSON.stringify(t))},loadToggleState(){const t=localStorage.getItem(e);return new SwitchConfig(JSON.parse(t))}}}();export default function LanguageToggleHelper(e=null){e?(!e instanceof SwitchConfig&&(e=new SwitchConfig(e)),userSettings.saveToggleState(e)):e=userSettings.loadToggleState();const t=langs.map((({id:t,label:a})=>new DataItem(t,e[t],!1,a,s)));let a=!1,n=[];const l=[];function g(){n=t.filter((e=>e.available)),l.forEach((e=>e(n)))}function s(e){if(!a||!e.available)return;const n=`[data-toggle-lang="${e.lang}"]`,l=!e.enabled;a.querySelectorAll(n).forEach((e=>{e.hidden!==l&&(e.hidden=l)})),userSettings.saveToggleState(getLangToEnabledMap(t))}return{get dataList(){return t},get contextElement(){return a},set contextElement(e){this.bindContextElement(e)},bindContextElement(e){return e instanceof HTMLElement?e!==a&&(a=e):a=!1,this},reset(){const a=userSettings.loadToggleState();let n=!1,l=!1;return t.forEach((t=>{!1!==t.available&&(t.available=!1,l=!0);const g=a[t.lang],s=ensureValue(g,e[t.lang]);t.enabled!==s&&(t.enabled=s,l=!0),g!==s&&(n=!0)})),l&&g(),n&&userSettings.saveToggleState(getLangToEnabledMap()),this},get availableLanguages(){return n},updateAvailabilityByHtml(e){let a=!1;return t.forEach((t=>{const n=ensureValue(regexes[t.lang]&&regexes[t.lang].test(e),!1);t.available!==n&&(t.available=n,a=!0)})),a&&g(),this},updateAvailabilityByElement(){if(!a)return this;const e=a.querySelectorAll("[data-toggle-lang]");if(e.length>0){const a=new Set(Array.from(e,(e=>e.getAttribute("data-toggle-lang"))));let n=!1;t.forEach((e=>{const t=a.has(e.lang);e.available!==t&&(e.available=t,n=!0)})),n&&g()}return this},applyLanguageToggles(){if(n.length<1)return this;const e=getLangToEnabledMap(n);return a.querySelectorAll("[data-toggle-lang]").forEach((t=>{const a=t.getAttribute("data-toggle-lang"),n=!ensureValue(e[a]);t.hidden!==n&&(t.hidden=n)})),this},onAvailableLanguagesChange(e){"function"==typeof e&&l.push(e)},offAvailableLanguagesChange(e){const t=l.indexOf(e);-1!==t&&l.splice(t,1)},destroy(){l.length=0,a=null,n.length=0,t.length=0}}}